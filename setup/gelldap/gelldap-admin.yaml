---
apiVersion: v1
kind: Namespace
metadata:
  name: gelldap
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-ldap-admin
  namespace: gelldap
  labels:
    app: php-ldap-admin
spec:
  replicas: 1
  selector:
    matchLabels:
      app: php-ldap-admin
  template:
    metadata:
      name: php-ldap-admin
      labels:
        app: php-ldap-admin
    spec:
      #initContainers:
      containers:
      - name: php-ldap-admin
        image: osixia/phpldapadmin:0.9.0
        imagePullPolicy: IfNotPresent
        ports:
          - name: pla-port-s  ## pla=php ldap admin
            containerPort: 443
          - name: pla-port
            containerPort: 80
        env:
          - name: PHPLDAPADMIN_HTTPS
            value: "false"
          #- name: PHPLDAPADMIN_LDAP_HOSTS
          #  value: gelldap-service.gelldap.svc.cluster.local
          - name: PHPLDAPADMIN_LDAP_HOSTS
            value: "#PYTHON2BASH:[{'gelldap-service.gelldap.svc.cluster.local': [{'server': [{'tls': False},{'port': 389}]},{'login': [{'bind_id': 'cn=admin,dc=gelldap,dc=com'}]}]}]"
          - name: PHPLDAPADMIN_SERVER_ADMIN
            value: "webmaster@example.org"
          - name: PHPLDAPADMIN_SERVER_PATH
            value: "/phpldapadmin"
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: php-ldap-admin
  namespace: gelldap
spec:
  rules:
  - host: gelldap.gorcl.hornpolish.net
    http:
      paths:
      - backend:
          serviceName: php-ldap-admin
          servicePort: 80
        path: /
---
apiVersion: v1
kind: Service
metadata:
  name: php-ldap-admin
  namespace: gelldap
  labels:
    app: php-ldap-admin
  annotations:
    traefik.ingress.kubernetes.io/affinity: "true"
    traefik.ingress.kubernetes.io/session-cookie-name: "sticky"
spec:
  ports:
    - name: pla-port   ## pla is shorthand for php-ldap-admin
      port: 80
    - name: pla-port-s
      port: 443
  selector:
    app: php-ldap-admin
  sessionAffinity: ClientIP
