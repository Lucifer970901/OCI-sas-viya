---
apiVersion: viya.sas.com/v1alpha1
kind: CASDeployment
metadata:
  annotations:
    sas.com/component-name: sas-cas-operator
    sas.com/component-version: 2.5.19-20200910.1599746345742
    sas.com/config-init-mode: initcontainer
    sas.com/sas-access-config: "true"
    sas.com/version: 2.5.19
  labels:
    app: sas-cas-operator
    app.kubernetes.io/instance: default
    app.kubernetes.io/managed-by: sas-cas-operator
    app.kubernetes.io/name: cas
    sas.com/admin: namespace
    sas.com/backup-role: provider
    sas.com/deployment: sas-viya
    workload.sas.com/class: cas
  name: default
  namespace: viya
spec:
  backupControllers: 0
  controllerTemplate:
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: workload.sas.com/class
                operator: In
                values:
                - cas
            weight: 100
          - preference:
              matchExpressions:
              - key: workload.sas.com/class
                operator: NotIn
                values:
                - compute
                - stateless
                - stateful
            weight: 1
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.azure.com/mode
                operator: NotIn
                values:
                - system
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - sas-cas-server
              topologyKey: kubernetes.io/hostname
            weight: 100
      containers:
      - env:
        - name: SAS_LICENSE
          valueFrom:
            secretKeyRef:
              key: SAS_LICENSE
              name: sas-cas-license
        - name: CASLLP_01_ODBC
          value: /opt/sas/viya/home/lib64/accessclients/lib
        - name: CASLLP_02_POSTGRES
          value: /opt/sas/viya/home/lib64
        - name: ODBCHOME
          value: /opt/sas/viya/home/lib64/accessclients
        - name: ODBCINI
          value: /opt/sas/viya/home/lib64/accessclients/odbc.ini
        - name: ODBCINST
          value: /opt/sas/viya/home/lib64/accessclients/odbcinst.ini
        - name: ODBCSYSINI
          value: /opt/sas/viya/home/lib64/accessclients/
        - name: CASCFG_DQLOCALE
          value: ENUSA
        - name: CASCFG_DQSETUPLOC
          value: QKB CI 32
        envFrom:
        - configMapRef:
            name: sas-shared-config-5gc9794df6
        - configMapRef:
            name: sas-java-config-7g599227gm
        - configMapRef:
            name: sas-access-config-782dbg98k8
        - secretRef:
            name: sas-consul-client
        - configMapRef:
            name: sas-restore-job-parameters-6dh8htc9fg
        image: cr.sas.com/viya-4-x64_oci_linux_2-docker/sas-cas-server:1.7.6-20200916.1600277826260
        name: cas
        readinessProbe:
          httpGet:
            path: /internal/state
            port: 8777
          initialDelaySeconds: 3
          periodSeconds: 3
        resources:
          requests:
            cpu: 250m
            memory: 2Gi
        volumeMounts:
        - mountPath: /cas/permstore
          name: cas-default-permstore-volume
        - mountPath: /cas/data
          name: cas-default-data-volume
        - mountPath: /cas/cache
          name: cas-default-cache-volume
        - mountPath: /cas/config
          name: cas-default-config-volume
        - mountPath: /cas/license
          name: cas-license-volume
        - mountPath: /var/lib/sss
          name: sss
        - mountPath: /sasviyabackup
          name: backup
        - mountPath: /rdutil
          name: sas-rdutil-dir
        - mountPath: /opt/sas/viya/home/share/refdata/qkb
          name: sas-quality-knowledge-base-volume
      - env:
        - name: SAS_K8S_DEPLOYMENT_NAME
          value: sas-sssd-server
        envFrom:
        - configMapRef:
            name: sas-shared-config-5gc9794df6
        - configMapRef:
            name: sas-java-config-7g599227gm
        - secretRef:
            name: sas-consul-client
        image: cr.sas.com/viya-4-x64_oci_linux_2-docker/sas-sssd-server:1.1.2-20200828.1598635360630
        lifecycle:
          preStop:
            exec:
              command:
              - bash
              - -c
              - kill -SIGKILL $(ps -Af | grep '/opt/sas/viya/home/bin/consul-template'  | grep -v grep | awk '{print $2}')
              - kill -SIGKILL $(ps -Af | grep '/sbin/sssd'  | grep -v grep | awk '{print $2}')
        name: sssd
        resources:
          limits:
            cpu: 100m
            memory: 512Mi
          requests:
            cpu: 100m
            memory: 512Mi
        securityContext:
          runAsGroup: 0
          runAsUser: 0
        volumeMounts:
        - mountPath: /var/lib/sss
          name: sss
      - env:
        - name: SAS_TLS_SKIP_VERIFY
          value: "true"
        - name: BACKUP_MOUNT_LOCATION
          value: /sasviyabackup
        - name: BACKUP_SOURCE_MOUNTS
          value: cas-default-data-volume
        - name: cas-default-data-volume
          value: /cas/data
        - name: NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['casoperator.sas.com/cas-env-consul-name']
        - name: CAS_NODE_TYPE
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['casoperator.sas.com/node-type']
        - name: CAS_CONTROLLER_ACTIVE
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['casoperator.sas.com/controller-active']
        - name: CAS_CFG_MODE
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['casoperator.sas.com/cas-cfg-mode']
        - name: CAS_SERVICE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['casoperator.sas.com/service-name']
        envFrom:
        - configMapRef:
            name: sas-go-config-fb6bgt2k78
        - configMapRef:
            name: sas-shared-config-5gc9794df6
        - configMapRef:
            name: sas-java-config-7g599227gm
        - configMapRef:
            name: sas-backup-agent-parameters-hkfmm67f7d
        - secretRef:
            name: sas-consul-client
        image: cr.sas.com/viya-4-x64_oci_linux_2-docker/sas-backup-agent:2.10.8-20200921.1600690954675
        imagePullPolicy: IfNotPresent
        lifecycle:
          preStop:
            exec:
              command:
              - bash
              - -c
              - kill -SIGKILL $(ps -Af | grep 'backup-agent'  | grep -v grep | awk '{print $2}')
        name: sas-backup-agent
        resources:
          limits:
            cpu: 100m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 2Gi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /sasviyabackup
          name: backup
        - mountPath: /cas/data
          name: cas-default-data-volume
      imagePullSecrets:
      - name: sas-image-pull-secrets-bh7kmc9288
      initContainers:
      - env: []
        envFrom:
        - configMapRef:
            name: sas-go-config-fb6bgt2k78
        - configMapRef:
            name: sas-shared-config-5gc9794df6
        image: cr.sas.com/viya-4-x64_oci_linux_2-docker/sas-config-init:1.2.6-20200928.1601307316387
        name: sas-config-init
        volumeMounts:
        - mountPath: /cas/config/
          name: cas-default-config-volume
      securityContext:
        fsGroup: 1001
        runAsGroup: 1001
        runAsUser: 1001
      serviceAccountName: sas-cas-server
      tolerations:
      - effect: NoSchedule
        key: workload.sas.com/class
        operator: Equal
        value: cas
      volumes:
      - name: cas-default-permstore-volume
        persistentVolumeClaim:
          claimName: cas-default-permstore
      - name: cas-default-data-volume
        persistentVolumeClaim:
          claimName: cas-default-data
      - emptyDir: {}
        name: cas-default-cache-volume
      - emptyDir: {}
        name: cas-default-config-volume
      - name: cas-license-volume
        secret:
          items:
          - key: SAS_LICENSE
            path: license.sas
          secretName: sas-cas-license
      - emptyDir: {}
        name: sss
      - name: backup
        persistentVolumeClaim:
          claimName: sas-cas-backup-data
      - name: sas-quality-knowledge-base-volume
        persistentVolumeClaim:
          claimName: sas-quality-knowledge-base
      - configMap:
          defaultMode: 493
          name: sas-reference-data-scripts
        name: sas-rdutil-dir
  ingressTemplate:
    metadata:
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: 2048m
        nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
      labels: {}
    spec:
      rules:
      - host: viya.gorcl.hornpolish.net
  publishHTTPIngress: true
  workerTemplate: null
  workers: 3
