<html>
    <head>
        <link rel="stylesheet" type="text/css" href="sas.css"/>
        <title>Configure Python for SAS Viya</title>
    </head>
    <body>
        <h1 id="configure-python-for-sas-viya">Configure Python for SAS Viya</h1>
<h2 id="overview">Overview</h2>
<p>SAS Viya can use a customer-prepared environment consisting of a Python
installation and any required packages stored on a Kubernetes
Persistent Volume. This readme describes how to make that volume
available to your deployment.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>SAS Viya provides YAML files that the Kustomize tool uses to configure Python. Before you use those files, perform the following tasks:</p>
<ul>
<li>Note the attributes of the volume where Python and the associated packages are to be deployed. For example, for
  NFS, note the NFS server and directory. The &ldquo;Additional Resources&rdquo;
  section below contains links to more information about the various types
  of Persistent Volumes in Kubernetes.</li>
<li>Install Python and any necessary packages on the volume.</li>
<li>In addition to the volume attributes, you will need the following information for later:<ul>
<li>{{ PYTHON-EXECUTABLE }} - the name of the Python executable file (for example, python or python3.8)</li>
<li>{{ PYTHON-EXE-DIR }} - the directory (relative to the mount) containing the executable (for example, /bin)</li>
<li>{{ SAS-EXTLANG-SETTINGS-XML-FILE }} - configuration file for enabling Python and R integration in CAS. This is only required if you are using Python with CMP or the EXTLANG package.</li>
<li>{{ SAS-EXT-LLP-PYTHON-PATH }} - list of directories to look for when searching for run-time shared libraries (similar to LD_LIBRARY_PATH)</li>
</ul>
</li>
</ul>
<h2 id="installation">Installation</h2>
<ol>
<li>
<p>Copy the files in the <code>$deploy/sas-bases/examples/sas-open-source-config/python</code> directory
to the <code>$deploy/site-config/sas-open-source-config/python</code> directory. Create the target directory, if
it does not already exist.</p>
</li>
<li>
<p>The kustomization.yaml file defines all the necessary environment variables.
Replace all tags, such as {{ PYTHON-EXE-DIR }}, with what you gathered in
the &ldquo;Prerequisites&rdquo; step. Then, set the following parameters, according to the SAS products you will be using:</p>
</li>
<li>MAS_PYPATH and MAS_M2PATH are used by the SAS Micro Analytic Service.</li>
<li>DM_PYTHONHOME is used by the Open Source Code node in SAS Visual Data Mining and
  Machine Learning. The code in Open Source Code node runs by executing
  <code>$DM_PYTHONHOME/python &lt;editor_code.py&gt;</code>
  The above call expects an executable named &ldquo;python&rdquo; in {{ PYTHON-EXE-DIR }};
  if that is not available, consider creating a symbolic link &ldquo;python&rdquo; that
  points to {{ PYTHON-EXECUTABLE }}.</li>
<li>SAS_EXTLANG_SETTINGS is used by applications that run Python and R code on
  Cloud Analytic Services (CAS). This includes PROC FCMP and the
  Time Series External Languages (EXTLANG) package. SAS_EXTLANG_SETTINGS
  should only be set in one example file; for example, if you set it in
  the Python example, you should not set it the R example.
  SAS_EXTLANG_SETTINGS should point to an XML file that is readable by
  all users. The path can be in the same volume that contains the R
  environment or in any other volume that is accessible to CAS. Refer
  to the documentation for the Time Series External Languages (EXTLANG)
  package for details on the expected XML schema.</li>
<li>SAS_EXT_LLP_PYTHON is used when the base distribution or packages for open source
  software require additional run-time libraries that are not part of the shipped
  container image.</li>
</ol>
<p><strong><em>Note:</em></strong> Any environment variables that you define in this example
will be set on all pods, although they may not have an effect.
For example, setting MAS_PYPATH will not affect the Python executable
used by the EXTLANG package. That executable is set in the
SAS_EXTLANG_SETTINGS file. However, if you define $MAS_PYPATH you can then
use it in the SAS_EXTLANG_SETTINGS file. For example,
<code>&lt;LANGUAGE name="PYTHON3" interpreter="$MAS_PYPATH"&gt;&lt;/LANGUAGE&gt;</code></p>
<ol>
<li>Attach storage to your SAS Viya deployment.
The python-transformer.yaml file uses PatchTransformers in Kustomize
to attach the volume containing your Python installation to SAS Viya.
Replace {{ VOLUME-ATTRIBUTES }} with the appropriate volume specification.
For example, when using an NFS mount, the {{ VOLUME-ATTRIBUTES }} tag should be
replaced with <code>nfs: {path: /vol/python, server: myserver.sas.com}</code>
where <code>myserver.sas.com</code> is the NFS server and <code>/vol/python</code> is the
NFS path you recorded in the Prerequisites step.</li>
</ol>
<p>The relevant code excerpt from python-transformer.yaml file before the change:
<pre class="highlight"><code class="language-yaml">patch: |-
  # Add Python Volume
  - op: add
    path: /spec/template/spec/volumes/-
    value: { name: python-volume, {{ VOLUME-ATTRIBUTES }} }
  # Add mount path for Python
  - op: add
    path: /template/spec/containers/0/volumeMounts/-
    value:
      name: python-volume
    mountPath: {{ PY-MOUNTPATH }}
      readOnly: true</code></pre></p>
<p>The relevant code excerpt from python-transformer.yaml file after the change:
<pre class="highlight"><code class="language-yaml">patch: |-
  # Add Python Volume
  - op: add
    path: /spec/template/spec/volumes/-
    value: { name: python-volume, nfs: {path: /vol/python, server: myserver.sas.com} }
  # Add mount path for Python
  - op: add
    path: /template/spec/containers/0/volumeMounts/-
    value:
      name: python-volume
      mountPath: /nfs/python
      readOnly: true</code></pre></p>
<ol>
<li>Make the following changes to the base kustomization.yaml file in the $deploy directory.</li>
<li>Add site-config/sas-open-source-config/python to the resources block.</li>
<li>Add site-config/sas-open-source-config/python/python-transformer.yaml to the transformers block.</li>
</ol>
<h2 id="additional-resources">Additional Resources</h2>
<p>For more information about the SAS Viya deployment process, see the <a href="http://documentation.sas.com/?softwareId=mysas&amp;softwareVersion=prod&amp;docsetId=dplyml0phy0dkr&amp;docsetTarget=titlepage.htm&amp;locale=en">SAS Viya Deployment Guide</a>.</p>
<p>Information about Persistent Volumes on Kubernetes is located <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">here</a>.</p>
<p>For details of attributes for different kinds of volumes, like NFS, hostPath, PVC and others, refer to
  <a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes">Kubernetes documentation</a>.</p>
<p>The XML schema for the file pointed to by {{ SAS-EXTLANG-SETTINGS-XML-FILE }} is described in the
  <a href="http://documentation.sas.com/?cdcId=pgmsascdc&amp;cdcVersion=v_001&amp;docsetId=castsp&amp;docsetTarget=castsp_extlang_sect002.htm&amp;locale=en">EXTLANG documentation</a>.</p>
    </body>
</html>