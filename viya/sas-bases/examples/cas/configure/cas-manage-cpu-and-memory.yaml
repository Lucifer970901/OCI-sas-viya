# This block of code is for adding resource requests and resource limits for
# memory and CPU.
# For memory, the AMOUNT-OF-RAM value is a numeric value followed by the units,
# such as 32Gi for 32 gigabytes. In Kubernetes, the units for gigabytes is Gi.
# For CPUs, the NUMBER-OF-CORES is either a whole number, representing that
# number of cores, or a number followed by m, indicating that number of milli-cores.
# For example, 8 specifes to allocate 8 cores, and 5m specifies to allocate
# 500 milli-cores or .5 cores.
# By default, the requests for memory and CPU are set to 2G and .25 cores in
# overlays. That is why the patches use replace instead of add.
---
apiVersion: builtin
kind: PatchTransformer
metadata:
  name: cas-manage-cpu-and-memory
patch: |-
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/resources/limits
    value:
      memory: {{ AMOUNT-OF-RAM }}
  - op: replace
    path: /spec/controllerTemplate/spec/containers/0/resources/requests/memory
    value:
      {{ AMOUNT-OF-RAM }}
  - op: add
    path: /spec/controllerTemplate/spec/containers/0/resources/limits/cpu
    value:
      {{ NUMBER-OF-CORES }}
  - op: replace
    path: /spec/controllerTemplate/spec/containers/0/resources/requests/cpu
    value:
      {{ NUMBER-OF-CORES }}
target:
  group: viya.sas.com
  kind: CASDeployment
  name: .*
  version: v1alpha1
