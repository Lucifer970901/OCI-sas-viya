apiVersion: viya.sas.com/v1alpha1
kind: CASDeployment
metadata:
  name: default
spec:
  controllerTemplate:
   apiVersion: viya.sas.com/v1alpha1
kind: CASDeployment
metadata:
  annotations:
    sas.com/sas-access-config: "true"
    sas.com/config-init-mode: "initcontainer"
  labels:
    app: sas-cas-operator
    app.kubernetes.io/instance: "default"
    app.kubernetes.io/name: "cas"
    app.kubernetes.io/managed-by: sas-cas-operator
    sas.com/admin: "namespace"
    workload.sas.com/class: cas
  name: "default"
spec:
  controllerTemplate:
    spec:
      tolerations:
      - key: "workload.sas.com/class"
        operator: "Equal"
        value: "cas"
        effect: "NoSchedule"
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: workload.sas.com/class
                operator: In
                values:
                - cas
          - weight: 1
            preference:
              matchExpressions:
              - key: workload.sas.com/class
                operator: NotIn
                values:
                - compute
                - stateless
                - stateful
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.azure.com/mode
                operator: NotIn
                values:
                - system
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - sas-cas-server
              topologyKey: kubernetes.io/hostname
      initContainers:
      - image: sas-config-init
        name: sas-config-init
        env: []
        envFrom:
          - configMapRef:
              name: sas-go-config
          - configMapRef:
              name: sas-shared-config
        volumeMounts:
          - mountPath: /cas/config/
            name: cas-default-config-volume
      containers:
      - name: cas  # required name for the CAS container
        readinessProbe:
          httpGet:
            path: /internal/state
            port: 8777
          initialDelaySeconds: 3
          periodSeconds: 3
        #args:  # change the command so we can manually run the entrypoint script and debug cas
          #- while true; do sleep 30; done;
        #command:
          #- /bin/bash
          #- -c
          #- --
        env:
        #- name: CASCFG_SERVICESBASEURL  # Can be supplied automatically in future.
          #valueFrom:
            #configMapKeyRef:
              #name: sas-shared-config-k5d4tc69g7
              #key: SAS_URL_SERVICE_TEMPLATE
        #- name: CASENV_CONSUL_TOKEN  # Can be supplied automatically in future.
          #valueFrom:
            #configMapKeyRef:
              #name: sas-shared-config-h95fdtg2gc
              #key: CONSUL_TOKEN
        # - name: CASENV_CONSUL_NAME
          # value: "cas-shared-default"
        # - name: CASENV_CAS_VIRTUAL_PATH
          # value: "/cas-shared-default-http"
        - name: SAS_LICENSE
          valueFrom:
            secretKeyRef:
              key: SAS_LICENSE
              name: sas-cas-license
        envFrom:
        - configMapRef:
            name: sas-shared-config
        - configMapRef:
            name: sas-java-config
        - configMapRef:
            name: sas-access-config
        - secretRef:
            name: sas-consul-client
        image: sas-cas-server
        resources:
          requests:
            memory: 2Gi
            cpu: 250m
        volumeMounts:
        #- name: bigdisk
          #mountPath: "/bigdisk" # Example of mount supplied by user
        - name: cas-default-permstore-volume
          mountPath: /cas/permstore
        - name: cas-default-data-volume
          mountPath: /cas/data
        - name: cas-default-cache-volume
          mountPath: /cas/cache
        - name: cas-default-config-volume
          mountPath: /cas/config
        - name: cas-license-volume
          mountPath: /cas/license
      imagePullSecrets:
      - name: sas-image-pull-secrets
      serviceAccountName: sas-cas-server
      volumes:
      - name: cas-default-permstore-volume
        persistentVolumeClaim:
          claimName: cas-default-permstore
      - name: cas-default-data-volume
        persistentVolumeClaim:
          claimName: cas-default-data
      - name: cas-default-cache-volume
        emptyDir: {}
      - name: cas-default-config-volume
        emptyDir: {}
      - name: cas-license-volume
        secret:
          secretName: sas-cas-license
          items:
          - key: SAS_LICENSE
            path: license.sas
  workers: 2
  backupControllers: 0
  workerTemplate:
    #podSpec - optional worker template
  publishHTTPIngress: true
  ingressTemplate:
    spec:
      rules:
      - host: $(INGRESS_HOST)
    metadata:
      annotations: 
        nginx.ingress.kubernetes.io/proxy-body-size: 2048m
        nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
      labels: {}